<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="HAIP Token: Empowering AI and blockchain innovation through decentralized ecosystems." />
  <title>HAIP Token - Official Site</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>

  <!-- WalletConnect v2 EthereumProvider (CDN) -->
  <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.15.2/dist/index.umd.js"></script>

  <style>
    html { scroll-behavior: smooth; overflow-x: hidden; }
    body {
      font-family: 'Orbitron', sans-serif;
      background: url('images/background-cyber.jpg') no-repeat center center fixed;
      background-size: cover; color: #f8f8f8; margin: 0; padding: 0; min-width: 100%; overflow-x: hidden;
    }
    header { background: rgba(31, 40, 51, 0.85); padding: 20px; text-align: center; position: relative; }
    header h1 { color: #66fcf1; margin: 0; font-size: 1.8rem; }
    .logo-fixed { position: fixed; top: 25px; left: 25px; height: 100px; z-index: 999; cursor: pointer; transition: transform 0.3s ease; }
    .logo-fixed:hover { transform: scale(1.1); }
    main {
      padding: 20px; max-width: 900px; margin: auto; background-color: rgba(15, 32, 39, 0.8);
      border-radius: 15px; box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
    }
    section { margin-bottom: 20px; }
    h2 { color: #45a29e; margin-bottom: 10px; font-size: 1.5rem; }
    a { color: #66fcf1; text-decoration: none; }
    .contract {
      background: #1f2833; padding: 15px 20px; border-radius: 10px; word-break: break-word; font-family: monospace;
      font-size: 0.9rem; color: #66fcf1; text-align: center; border: 1px solid #0ff0fc; box-shadow: 0 0 12px rgba(0, 255, 252, 0.15);
      max-width: 100%; overflow-wrap: break-word; margin-bottom: 10px;
    }
    .btn {
      background: #66fcf1; color: #0b0c10; padding: 12px 24px; border: none; border-radius: 5px; font-weight: bold;
      text-transform: uppercase; cursor: pointer; margin-top: 10px; margin-right: 10px; display: inline-block;
      transition: background 0.3s ease, transform 0.3s ease; position: relative; font-size: 1rem; min-width: 120px; touch-action: manipulation;
    }
    .btn:hover { background: #0ff0fc; transform: scale(1.05); }
    .btn:disabled { background: #4a6360; cursor: not-allowed; opacity: 0.7; }
    .btn.loading::after {
      content: ''; position: absolute; width: 16px; height: 16px; top: 50%; right: 10px; transform: translateY(-50%);
      border: 2px solid #0b0c10; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: translateY(-50%) rotate(0deg);} 100% { transform: translateY(-50%) rotate(360deg);} }
    .partner-logo { transition: transform 0.5s ease, filter 0.5s ease; background-color: transparent; filter: drop-shadow(0 0 5px rgba(102, 252, 241, 0.4)); max-width: 140px; }
    .partner-logo:hover { transform: scale(1.1); filter: drop-shadow(0 0 25px #00f9ff); }
    .future-partner-logo { height: 50px; margin: 10px 20px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(102, 252, 241, 0.3)); transition: transform 0.3s ease, filter 0.3s ease; }
    .future-partner-logo:hover { transform: scale(1.1); filter: drop-shadow(0 0 15px #00f9ff); }
    .future-partner-logo.bybit { height: 150px; }
    .future-partner-logo.crypto-com { height: 100px; max-width: 100px; }
    .future-partner-logo.okx { height: 100px; max-width: 100px; }
    .logo-section { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; padding: 20px; }
    .presale-stage {
      background: rgba(31, 40, 51, 0.7); border-left: 4px solid #66fcf1; padding: 15px; margin-bottom: 10px; border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 249, 255, 0.1); animation: fadeInUp 1s ease both; transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease; cursor: pointer;
    }
    .presale-stage:hover { transform: scale(1.02); box-shadow: 0 0 25px rgba(0, 249, 255, 0.3); background: rgba(31, 40, 51, 0.9); }
    .presale-stage h3 { margin-top: 0; color: #0ff0fc; font-size: 1.2rem; }
    .presale-stage p { margin: 5px 0; color: #f0f0f0; font-size: 0.9rem; }
    .countdown {
      text-align: center; font-size: 1.5rem; color: #0ff0fc; margin: 20px auto; font-weight: bold; text-shadow: 0 0 15px #0ff0fc;
      border: 2px solid #0ff0fc; border-radius: 10px; padding: 15px; width: fit-content; background: rgba(0, 255, 255, 0.05);
      animation: glowPulse 2s ease-in-out infinite;
    }
    .newsletter-form { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .newsletter-form input {
      padding: 10px; border: 1px solid #66fcf1; border-radius: 5px; background: #1f2833; color: #f8f8f8; width: 100%; box-sizing: border-box;
    }
    .newsletter-form button { background: #66fcf1; color: #0b0c10; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    .token-details { display: grid; grid-template-columns: repeat(3, minmax(200px, 1fr)); gap: 15px; margin: 10px 0; }
    .token-details div {
      background: #1f2833; padding: 15px; border-radius: 10px; text-align: center; color: #f8f8f8; border: 2px solid #1f2833;
      transition: border-color 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; align-items: center;
    }
    .token-details div strong { color: #66fcf1; display: block; margin-bottom: 5px; }
    .token-details div:hover { border-color: #0ff0fc; box-shadow: 0 0 15px #0ff0fc, 0 0 30px rgba(0, 255, 252, 0.5); }
    .token-details div img { max-width: 80%; height: auto; margin-top: 10px; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes glowPulse { 0%, 100% { box-shadow: 0 0 10px #0ff0fc, 0 0 20px #0ff0fc; } 50% { box-shadow: 0 0 20px #0ff0fc, 0 0 30px #0ff0fc; } }
    canvas#tokenomicsChart { display: block; max-width: 300px; width: 100%; margin: 0 auto; }
    .tokenomics-section p:last-child { margin-bottom: 5px; }
    .tokenomics-container .chart-legend { font-size: 1rem; text-align: center; padding: 0 10px; }
    .tokenomics-container .chart-legend p { margin: 5px 0; }
    .presale-status { font-size: 1rem; color: #f0f0f0; margin-bottom: 10px; word-break: break-word; }
    .live-status { font-size: .95rem; color: #bfefff; opacity: .9; margin-bottom: 15px; min-height: 1.2em; }
    .presale-limits { font-size: 1.2rem; color: #0ff0fc; margin-bottom: 20px; text-shadow: 0 0 10px #0ff0fc; }
    .presale-actions { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    .presale-input { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
    .presale-input input {
      padding: 10px; border: 1px solid #66fcf1; border-radius: 5px; background: #1f2833; color: #f8f8f8; width: 100%; max-width: 300px; margin: 0 auto;
      text-align: center; font-size: 1.1rem;
    }
    .presale-input.hidden { display: none; }
    :root{
      --haip-teal:#66fcf1; --haip-cyan:#0ff0fc; --haip-bg:#0b0c10; --haip-card:#1f2833;
    }
    .presale-v3{display:grid; gap:14px;}
    .presale-card{background:rgba(31,40,51,.92); border:1px solid #0ff0fc22; border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,249,255,.15); backdrop-filter: blur(4px);}
    .presale-head{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
    .presale-title{font-size:1.2rem; color:var(--haip-teal); margin:0}
    .badge-stage{font-size:.85rem; border:1px solid #0ff0fc44; color:#bff; padding:4px 10px; border-radius:999px}
    .kv{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .kv .box{background:#152028; border:1px solid #0b2a31; border-radius:10px; padding:10px; text-align:center}
    .kv .box b{display:block; color:var(--haip-teal); margin-bottom:2px}
    .progress{height:12px; background:#132029; border:1px solid #0ff0fc33; border-radius:999px; overflow:hidden}
    .progress>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--haip-teal),var(--haip-cyan)); box-shadow:0 0 14px #0ff0fc66 inset; transition:width .6s ease}
    .quote{font-size:.95rem; color:#d9ffff; opacity:.9; text-align:center}
    .amount-chips{display:flex; flex-wrap:wrap; gap:8px; justify-content:center}
    .chip{padding:8px 12px; border:1px solid #0ff0fc44; background:#142129; color:#eaffff; border-radius:999px; cursor:pointer; transition:transform .15s ease, border-color .2s ease}
    .chip:hover{transform:translateY(-1px); border-color:#0ff0fc99}
    .chip.active{background:#122; border-color:#0ff0fc; box-shadow:0 0 10px #0ff0fc55 inset}
    .presale-actions .btn{min-width:140px}
    .sticky-cta{position:fixed; left:0; right:0; bottom:12px; display:none; justify-content:center; z-index:1000; padding:0 12px}
    .sticky-cta .btn{width:100%; max-width:460px; border-radius:999px; box-shadow:0 10px 30px rgba(0,249,255,.25)}
    .toast{position:fixed; bottom:70px; left:50%; transform:translateX(-50%) translateY(20px); opacity:0; background:#12242c; color:#eaffff; padding:10px 14px; border:1px solid #0ff0fc55; border-radius:10px; z-index:1100; transition:all .25s ease}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    @media(min-width: 740px){
      .kv{grid-template-columns:repeat(4,1fr)}
      .presale-title{font-size:1.35rem}
    }
    .presale-v3 input[type="text"]{width:100%; max-width:320px; margin:0 auto; display:block; text-align:center; font-size:1.1rem;}

    /* ===== Wallet chooser modal ===== */
    .wc-modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center;
      z-index:2000; padding:18px;
    }
    .wc-modal{
      width:min(420px, 92vw);
      background: rgba(31,40,51,.96);
      border:1px solid #0ff0fc33;
      border-radius:16px;
      box-shadow:0 12px 40px rgba(0,249,255,.2);
      padding:16px;
      text-align:center;
    }
    .wc-modal h3{margin:6px 0 10px; color:#66fcf1; font-size:1.2rem}
    .wc-modal p{margin:0 0 12px; color:#d9ffff; opacity:.9; font-size:.92rem}
    .wc-grid{display:grid; gap:10px; margin-top:10px}
    .wc-btn{
      width:100%;
      background:#142129;
      border:1px solid #0ff0fc44;
      color:#eaffff;
      border-radius:12px;
      padding:12px 12px;
      cursor:pointer;
      font-family:'Orbitron', sans-serif;
      transition:transform .12s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .wc-btn:hover{transform:translateY(-1px); border-color:#0ff0fc99; box-shadow:0 0 14px #0ff0fc22 inset}
    .wc-row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .wc-tag{font-size:.82rem; opacity:.85}
    .wc-close{
      margin-top:10px;
      background:transparent;
      border:1px solid #0ff0fc33;
      color:#bfefff;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
    }
    .wc-note{margin-top:10px; font-size:.82rem; opacity:.85; color:#bfefff; line-height:1.35}
  </style>
</head>

<body>
<a href="#top"><img src="images/haip-logo-transparent.png" alt="HAIP Logo" class="logo-fixed" /></a>
<header id="top">
  <h1>Hp Artificial Intelligence Power (HAIP)</h1>
  <p>The official BEP20 token powering AI innovation on Binance Smart Chain</p>
</header>

<main>
  <!-- ABOUT -->
  <section data-aos="fade-up">
    <h2>About HAIP</h2>
    <p>HAIP is a BEP-20 token on Binance Smart Chain designed to fund and integrate artificial intelligence with decentralized finance (DeFi) and Web3 ecosystems. Leveraging smart contracts, Chainlink oracles, and IPFS storage, HAIP empowers AI-driven dApps and community governance through a decentralized DAO.</p>
    <a class="btn" href="#presale">Join Presale</a>
  </section>

  <!-- TOKEN DETAILS -->
  <section data-aos="fade-up">
    <h2>Token Details</h2>
    <div class="token-details">
      <div><strong>Token Name</strong> Hp Artificial Intelligence Power <img src="images/logos/hp.png" alt="HP Logo" style="display:block;max-width:80%;height:auto;margin:10px auto 0;"></div>
      <div><strong>Symbol</strong> HAIP <img src="images/haip-logo-transparent.png" alt="HAIP Logo" style="display:block;max-width:80%;height:auto;margin:10px auto 0;"></div>
      <div><strong>Decimals</strong> 18 <img src="images/haip-logo-transparent.png" alt="HAIP Logo" style="display:block;max-width:80%;height:auto;margin:10px auto 0;"></div>
      <div><strong>Total Supply</strong> 18,000,000,000 HAIP <img src="images/haip-logo-transparent.png" alt="HAIP Logo" style="display:block;max-width:80%;height:auto;margin:10px auto 0;"></div>
      <div><strong>Network</strong> Binance Smart Chain (BEP20) <img src="images/logos/bnb.png" alt="BNB Logo" style="display:block;max-width:80%;height:auto;margin:10px auto 0;"></div>
      <div>
        <strong>Contract</strong>
        <div class="contract">0x2e5a3548a65e41e119efa48cf67bfdfc361d1a29</div>
        <button class="btn" onclick="copyContract()">Copy Contract</button>
      </div>
    </div>
  </section>

  <!-- TOKENOMICS -->
  <section data-aos="fade-up" class="tokenomics-section">
    <h2>Tokenomics</h2>
    <p><strong>Total Supply:</strong> 18,000,000,000 HAIP</p>
    <ul>
      <li><strong>Presale:</strong> 54% (9.72B HAIP, allocated across private and public stages)</li>
      <li><strong>DEX Liquidity:</strong> 27% (4.86B HAIP, for trading on PancakeSwap)</li>
      <li><strong>Development:</strong> 10% (1.8B HAIP, vested over 2 years)</li>
      <li><strong>Partners:</strong> 9% (1.62B HAIP, for strategic collaborations)</li>
    </ul>
    <p><strong>Vesting:</strong> Team and partner tokens vested over 2 years to ensure long-term commitment.</p>
  </section>
  <div class="tokenomics-container">
    <div class="chart-legend">
      <p><span style="color:#66fcf1;">Presale (54%)</span></p>
      <p><span style="color:#0ff0fc;">DEX Liquidity (27%)</span></p>
      <p><span style="color:#2c3e50;">Development (10%)</span></p>
      <p><span style="color:#08fdd8;">Partners (9%)</span></p>
    </div>
    <canvas id="tokenomicsChart" class="tokenomics-chart"></canvas>
  </div>

  <!-- COUNTDOWN -->
  <section data-aos="fade-up">
    <h2>Presale Countdown</h2>
    <div class="countdown" id="countdown"></div>
  </section>

  <!-- PRIVATE PRESALE SECTION -->
  <section id="presale" class="presale-v3" data-aos="fade-up" data-aos-delay="60">
    <h2>Join Private Presale - LIVE NOW</h2>

    <div class="presale-card">
      <div class="presale-head">
        <h3 class="presale-title">Private Presale</h3>
        <span class="badge-stage" style="background:#00ff9d;color:#000;font-weight:bold;padding:6px 12px;border-radius:999px;">
          LIVE · Stage 0
        </span>
      </div>
      <div class="kv" style="margin:10px 0">
        <div class="box"><b>Price</b><div>0.00009 USDT / HAIP</div></div>
        <div class="box"><b>Your Limit (USDT)</b><div id="v3YourLimit">—</div></div>
        <div class="box"><b>Sold</b><div id="v3StageSold">—</div></div>
        <div class="box"><b>Remaining</b><div id="v3StageRemaining">—</div></div>
      </div>
      <div class="progress"><i id="v3StageProgress"></i></div>
      <p class="quote" id="v3Quote" style="color:#a0ffc0;font-weight:bold;">
        Private Presale is LIVE! Min: 3.24 USDT · Max: 90 USDT
      </p>
    </div>

    <div class="presale-card">
      <div class="presale-status" id="presaleWalletStatus">Wallet not connected</div>
      <div class="live-status" id="gasStatus"></div>

      <div class="presale-limits" style="color:#00ff9d;font-weight:bold;font-size:1.1rem;">
        PRIVATE PRESALE ACTIVE · Min 3.24 USDT · Max 90 USDT
      </div>

      <div class="amount-chips" id="chipsRow" style="margin:16px 0">
        <button class="chip active" data-usdt="3.24">3.24</button>
        <button class="chip" data-usdt="10">+10</button>
        <button class="chip" data-usdt="25">+25</button>
        <button class="chip" data-usdt="50">+50</button>
        <button class="chip" data-usdt="0" data-max="1">Max (90)</button>
      </div>

      <div class="presale-input">
        <input type="text" id="purchaseAmount" placeholder="Enter USDT amount (3.24 - 90)" value="3.24" />
      </div>

      <div class="presale-actions" style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:16px">
        <button class="btn" id="presaleConnectWalletBtn">Connect Wallet</button>
        <button class="btn hidden" id="presaleDisconnectWalletBtn">Disconnect Wallet</button>
        <button class="btn" id="purchaseBtn" disabled>Purchase HAIP</button>
      </div>
    </div>

    <div class="sticky-cta" id="stickyCta">
      <button class="btn" id="stickyBuyBtn">Buy Now (Private Sale)</button>
    </div>
    <div class="toast" id="toast">Copied!</div>
  </section>
</main>

<!-- Wallet chooser modal (hidden by default) -->
<div class="wc-modal-backdrop" id="walletModal">
  <div class="wc-modal">
    <h3>Choose wallet</h3>
    <p>Select how you want to connect:</p>

    <div class="wc-grid">
      <button class="wc-btn" id="btnWC">
        <div class="wc-row">
          <span><b>WalletConnect</b></span>
          <span class="wc-tag">Recommended (stays in this browser)</span>
        </div>
      </button>

      <button class="wc-btn" id="btnMM">
        <div class="wc-row">
          <span><b>MetaMask</b></span>
          <span class="wc-tag">Opens MetaMask in-app browser</span>
        </div>
      </button>

      <button class="wc-btn" id="btnTW">
        <div class="wc-row">
          <span><b>Trust Wallet</b></span>
          <span class="wc-tag">Opens Trust in-app browser</span>
        </div>
      </button>
    </div>

    <div class="wc-note">
      Note: MetaMask/Trust deep links will open inside the wallet browser.
      If you want to stay in Safari/Chrome, use WalletConnect.
    </div>

    <button class="wc-close" id="btnCloseWalletModal">Close</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
window.onload = function() {
  AOS.init({ duration: 1000 });

  // ================= COUNTDOWN =================
  const countdown = document.getElementById('countdown');
  const launchDate = new Date('2025-08-01T00:00:00Z').getTime();
  const updateCountdown = () => {
    const now = new Date().getTime();
    const d = launchDate - now;
    if (d <= 0) {
      countdown.innerHTML = "Private Presale is Live!";
      countdown.style.animation = 'none';
      countdown.style.border = '2px solid #66fcf1';
      return;
    }
    const days = Math.floor(d / (1000*60*60*24));
    const hours = Math.floor((d % (1000*60*60*24)) / (1000*60*60));
    const minutes = Math.floor((d % (1000*60*60)) / (1000*60));
    const seconds = Math.floor((d % (1000*60)) / 1000);
    countdown.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
  };
  setInterval(updateCountdown, 1000);
  updateCountdown();

  // ================= TOKENOMICS CHART =================
  const ctx = document.getElementById('tokenomicsChart')?.getContext('2d');
  if (ctx) {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Presale (54%)', 'DEX Liquidity (27%)', 'Development (10%)', 'Partners (9%)'],
        datasets: [{
          data: [54, 27, 10, 9],
          backgroundColor: ['#66fcf1', '#0ff0fc', '#2c3e50', '#08fdd8'],
          borderColor: '#0b0c10',
          borderWidth: 2,
          hoverOffset: 20
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: { animateScale: true, animateRotate: true },
        plugins: { legend: { display: false } }
      }
    });
  }

  // ================= PRESALE / WEB3 =================
  const presaleWalletStatus        = document.getElementById('presaleWalletStatus');
  const presaleConnectWalletBtn    = document.getElementById('presaleConnectWalletBtn');
  const presaleDisconnectWalletBtn = document.getElementById('presaleDisconnectWalletBtn');
  const purchaseBtn                = document.getElementById('purchaseBtn');
  const purchaseAmountInput        = document.getElementById('purchaseAmount');
  const gasStatus                  = document.getElementById('gasStatus');

  const v3YourLimitEl      = document.getElementById('v3YourLimit');
  const v3StageSoldEl      = document.getElementById('v3StageSold');
  const v3StageRemainingEl = document.getElementById('v3StageRemaining');
  const v3StageProgressEl  = document.getElementById('v3StageProgress');
  const v3QuoteEl          = document.getElementById('v3Quote');

  const stickyBuyBtn = document.getElementById('stickyBuyBtn');

  // Wallet modal elements
  const walletModal = document.getElementById('walletModal');
  const btnMM = document.getElementById('btnMM');
  const btnTW = document.getElementById('btnTW');
  const btnWC = document.getElementById('btnWC');
  const btnCloseWalletModal = document.getElementById('btnCloseWalletModal');

  function openWalletModal() { walletModal.style.display = 'flex'; }
  function closeWalletModal() { walletModal.style.display = 'none'; }

  // CONTRACTS
  const HAIP_ADDRESS    = '0x2e5a3548a65e41e119efa48cf67bfdfc361d1a29';
  const USDT_ADDRESS    = '0x55d398326f99059fF775485246999027B3197955'; // USDT BSC (18 decimals)
  const PRESALE_ADDRESS = '0x6D07c3B6eAfB9433E234DF74dff12B3eaf8355ED';

  const HAIP_ABI = [
    {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}
  ];

  const USDT_ABI = [
    {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}
  ];

  const PRESALE_ABI = [
    {"inputs":[{"internalType":"uint256","name":"usdtAmount","type":"uint256"}],"name":"buy","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[],"name":"currentStage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"stageIdx","type":"uint256"}],"name":"getStage","outputs":[
      {"internalType":"uint256","name":"price","type":"uint256"},
      {"internalType":"uint256","name":"minUsdt","type":"uint256"},
      {"internalType":"uint256","name":"maxUsdt","type":"uint256"},
      {"internalType":"uint256","name":"cap","type":"uint256"},
      {"internalType":"uint256","name":"sold","type":"uint256"}
    ],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"stageIdx","type":"uint256"},{"internalType":"address","name":"user","type":"address"}],"name":"maxUsdtUserCanBuy","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
  ];

  let web3, haipContract, usdtContract, presaleContract;
  let connectedAddress = null;
  let haipDec = 18, usdtDec = 18;
  let externalProvider = null; // can be WalletConnect provider

  // ========= UTIL: string -> BN with N decimals =========
  const toUnits = (val, decimals) => {
    if (!web3) return null;
    if (!val || val === '' || val === '0') return web3.utils.toBN(0);

    let str = String(val).trim().replace(',', '.');
    str = str.replace(/[^0-9.]/g, '');
    if (!str || str === '.' || str === '') return web3.utils.toBN(0);

    const parts = str.split('.');
    let intPart = parts[0] || '0';
    let fracPart = (parts[1] || '');

    fracPart = (fracPart + '0'.repeat(decimals)).slice(0, decimals);

    const finalStr = intPart + fracPart;
    const normalized = finalStr.replace(/^0+/, '') || '0';

    return web3.utils.toBN(normalized);
  };

  // ========= INIT WEB3 =========
  async function initWeb3() {
    try {
      const providerToUse = externalProvider || window.ethereum || (window.web3 && window.web3.currentProvider);

      if (!providerToUse) {
        presaleWalletStatus.textContent = 'No wallet provider detected';
        return false;
      }

      web3 = new Web3(providerToUse);

      haipContract    = new web3.eth.Contract(HAIP_ABI, HAIP_ADDRESS);
      usdtContract    = new web3.eth.Contract(USDT_ABI, USDT_ADDRESS);
      presaleContract = new web3.eth.Contract(PRESALE_ABI, PRESALE_ADDRESS);

      try {
        const haipDecRaw = await haipContract.methods.decimals().call();
        haipDec = Number(haipDecRaw) || 18;
      } catch(e) { haipDec = 18; }

      try {
        const usdtDecRaw = await usdtContract.methods.decimals().call();
        usdtDec = Number(usdtDecRaw) || 18;
      } catch(e) { usdtDec = 18; }

      return true;
    } catch (e) {
      presaleWalletStatus.textContent = 'Web3 init error: ' + (e.message || e);
      return false;
    }
  }

  // ========= REFRESH LIMIT / STAGE =========
  async function v3Refresh() {
    if (!web3 || !presaleContract || !connectedAddress) return;

    try {
      const maxUserRaw = await presaleContract.methods.maxUsdtUserCanBuy(0, connectedAddress).call();
      const maxUserFloat = Number(maxUserRaw) / (10 ** usdtDec);

      if (maxUserFloat > 0) {
        v3YourLimitEl.textContent = maxUserFloat.toFixed(2);
        v3QuoteEl.textContent = `You can buy up to ${maxUserFloat.toFixed(2)} USDT in Private Presale.`;
        v3QuoteEl.style.color = '#a0ffc0';
        purchaseBtn.disabled = false;
      } else {
        v3YourLimitEl.textContent = '0.00';
        v3QuoteEl.textContent = 'Not eligible for Private Presale.';
        v3QuoteEl.style.color = '#ff6b6b';
        purchaseBtn.disabled = true;
      }

      try {
        const stageIdx = await presaleContract.methods.currentStage().call();
        const stageData = await presaleContract.methods.getStage(stageIdx).call();

        const capTokens  = parseFloat(web3.utils.fromWei(stageData.cap.toString(),  'ether'));
        const soldTokens = parseFloat(web3.utils.fromWei(stageData.sold.toString(), 'ether'));

        if (!isNaN(capTokens) && !isNaN(soldTokens)) {
          const remaining = capTokens - soldTokens;

          v3StageSoldEl.textContent      = Math.max(0, soldTokens).toLocaleString();
          v3StageRemainingEl.textContent = Math.max(0, remaining).toLocaleString();

          const pct = capTokens > 0 ? (soldTokens * 100 / capTokens) : 0;
          v3StageProgressEl.style.width = pct.toFixed(2) + '%';
        }
      } catch (e2) {
        console.warn('Stage info error:', e2);
      }

    } catch (e) {
      console.error('v3Refresh error:', e);
    }
  }

  // ========= MOBILE LINKS =========
  function metamaskDappLink() {
    const clean = window.location.href.replace(/^https?:\/\//, '');
    return `https://metamask.app.link/dapp/${clean}`;
  }
  function trustDappLink() {
    const url = encodeURIComponent(window.location.href);
    return `https://link.trustwallet.com/open_url?coin_id=20000714&url=${url}`;
  }

  // ========= WALLETCONNECT CONNECT =========
  async function connectViaWalletConnect() {
    try {
      closeWalletModal();
      presaleWalletStatus.textContent = 'Opening WalletConnect...';

      // IMPORTANT: set your WalletConnect projectId here
      const WC_PROJECT_ID = 'PUT_YOUR_WC_PROJECT_ID_HERE';

      // BSC mainnet chain id 56
      externalProvider = await window.WalletConnectEthereumProvider.EthereumProvider.init({
        projectId: WC_PROJECT_ID,
        chains: [56],
        optionalChains: [1],
        showQrModal: true,
        rpcMap: {
          56: "https://bsc-dataseed.binance.org/"
        }
      });

      // This will open the wallet selection modal (or wallet app)
      await externalProvider.connect();

      const ok = await initWeb3();
      if (!ok) throw new Error('WalletConnect init failed');

      const accounts = await externalProvider.request({ method: 'eth_accounts' });
      connectedAddress = accounts && accounts[0] ? accounts[0] : null;
      if (!connectedAddress) throw new Error('No account returned');

      presaleWalletStatus.textContent =
        `Connected: ${connectedAddress.slice(0,6)}...${connectedAddress.slice(-4)}`;

      presaleConnectWalletBtn.classList.add('hidden');
      presaleDisconnectWalletBtn.classList.remove('hidden');

      purchaseAmountInput.value = '3.24';
      purchaseAmountInput.dispatchEvent(new Event('input'));

      await v3Refresh();
    } catch (e) {
      console.error(e);
      externalProvider = null;
      presaleWalletStatus.textContent = 'WalletConnect failed';
    }
  }

  // ========= CONNECT WALLET (UPDATED with popup) =========
  async function connectWallet() {
    presaleConnectWalletBtn.classList.add('loading');
    presaleConnectWalletBtn.disabled = true;

    try {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      // Mobile without injected wallet -> show popup
      if (isMobile && !window.ethereum && !externalProvider) {
        presaleWalletStatus.textContent = "Choose a wallet to connect...";
        openWalletModal();
        return;
      }

      // Normal case (desktop / injected provider / already walletconnect)
      const ok = await initWeb3();
      if (!ok) throw new Error('No wallet detected');

      const provider = externalProvider || window.ethereum;
      const accounts = await provider.request({ method: 'eth_requestAccounts' });

      connectedAddress = accounts[0];

      presaleWalletStatus.textContent =
        `Connected: ${connectedAddress.slice(0,6)}...${connectedAddress.slice(-4)}`;

      presaleConnectWalletBtn.classList.add('hidden');
      presaleDisconnectWalletBtn.classList.remove('hidden');

      purchaseAmountInput.value = '3.24';
      purchaseAmountInput.dispatchEvent(new Event('input'));

      await v3Refresh();

    } catch (err) {
      console.error(err);
      presaleWalletStatus.textContent = 'Wallet connection failed';
    } finally {
      presaleConnectWalletBtn.classList.remove('loading');
      presaleConnectWalletBtn.disabled = false;
    }
  }

  // ========= PURCHASE TOKENS =========
  async function purchaseTokens() {
    purchaseBtn.classList.add('loading');
    purchaseBtn.disabled = true;

    try {
      if (!connectedAddress) throw new Error('Connect wallet first');

      if (!web3 || !usdtContract || !presaleContract) {
        const ok = await initWeb3();
        if (!ok) throw new Error('Web3 not initialized');
      }

      let inputVal = purchaseAmountInput.value.trim().replace(',', '.');
      if (!inputVal || inputVal === '0') throw new Error('Enter amount');

      let amount = parseFloat(inputVal);
      if (isNaN(amount)) throw new Error('Invalid amount');

      if (amount < 3.24 || amount > 90) {
        throw new Error('Amount must be between 3.24 and 90 USDT');
      }

      amount = Math.round(amount * 100) / 100;
      purchaseAmountInput.value = amount.toFixed(2);

      const usdtUnits = toUnits(amount, usdtDec);
      if (!usdtUnits || usdtUnits.isZero()) throw new Error('Invalid amount after conversion');

      const provider = externalProvider || window.ethereum;

      const allowanceRaw = await usdtContract.methods.allowance(connectedAddress, PRESALE_ADDRESS).call();
      const allowanceBN  = web3.utils.toBN(allowanceRaw);

      if (allowanceBN.lt(usdtUnits)) {
        gasStatus.textContent = 'Approving USDT...';
        await usdtContract.methods
          .approve(PRESALE_ADDRESS, usdtUnits.toString())
          .send({ from: connectedAddress });
      }

      gasStatus.textContent = 'Buying HAIP...';

      const tx = await presaleContract.methods
        .buy(usdtUnits.toString())
        .send({ from: connectedAddress });

      presaleWalletStatus.innerHTML =
        `SUCCESS! <a href="https://bscscan.com/tx/${tx.transactionHash}" target="_blank">View Tx</a>`;
      purchaseAmountInput.value = '';
      await v3Refresh();

    } catch (err) {
      console.error(err);
      presaleWalletStatus.textContent = 'Error: ' + (err.message || 'Transaction failed');
    } finally {
      purchaseBtn.classList.remove('loading');
      purchaseBtn.disabled = false;
      gasStatus.textContent = '';
    }
  }

  // ========= INPUT VALIDATION =========
  purchaseAmountInput.oninput = function() {
    let val = this.value.replace(/[^0-9.,]/g, '').replace(',', '.');
    if (!val || val === '.') val = '3.24';
    let num = parseFloat(val);
    if (isNaN(num) || num < 3.24) num = 3.24;
    if (num > 90) num = 90;
    this.value = num.toFixed(2);

    purchaseBtn.disabled = (num < 3.24 || num > 90 || !connectedAddress);
  };

  // ========= QUICK CHIPS =========
  document.querySelectorAll('.chip').forEach(ch => {
    ch.onclick = () => {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      ch.classList.add('active');

      let current = parseFloat(purchaseAmountInput.value) || 0;
      if (ch.dataset.max === '1') {
        const limTxt = v3YourLimitEl.textContent;
        let lim = parseFloat(limTxt);
        if (isNaN(lim) || lim <= 0) lim = 90;
        current = lim;
      } else {
        current += parseFloat(ch.dataset.usdt);
      }

      if (current > 90) current = 90;
      if (current < 3.24) current = 3.24;

      purchaseAmountInput.value = current.toFixed(2);
      purchaseAmountInput.dispatchEvent(new Event('input'));
    };
  });

  // ========= COPY CONTRACT =========
  window.copyContract = () => {
    navigator.clipboard.writeText('0x2e5a3548a65e41e119efa48cf67bfdfc361d1a29');
    const toast = document.getElementById('toast');
    if (toast) {
      toast.textContent = 'Contract copied!';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
  };

  // ========= STICKY CTA =========
  if (stickyBuyBtn && purchaseAmountInput) {
    stickyBuyBtn.onclick = () => {
      document.getElementById('presale').scrollIntoView({ behavior: 'smooth' });
      setTimeout(() => purchaseAmountInput.focus(), 700);
    };
  }

  // ========= WALLET MODAL BUTTONS =========
  btnCloseWalletModal.onclick = closeWalletModal;
  walletModal.addEventListener('click', (e) => {
    if (e.target === walletModal) closeWalletModal();
  });

  btnMM.onclick = () => {
    closeWalletModal();
    presaleWalletStatus.textContent = "Opening MetaMask app...";
    window.location.href = metamaskDappLink();
  };

  btnTW.onclick = () => {
    closeWalletModal();
    presaleWalletStatus.textContent = "Opening Trust Wallet app...";
    window.location.href = trustDappLink();
  };

  btnWC.onclick = () => connectViaWalletConnect();

  // ========= BUTTON EVENTS =========
  presaleConnectWalletBtn.onclick   = connectWallet;

  presaleDisconnectWalletBtn.onclick = async () => {
    try {
      if (externalProvider && externalProvider.disconnect) {
        await externalProvider.disconnect();
      }
    } catch(e) {}
    externalProvider = null;
    location.reload();
  };

  purchaseBtn.onclick = purchaseTokens;

  // ========= PRE-INIT WEB3 (OPTIONAL) =========
  (async () => {
    if (window.ethereum) {
      await initWeb3();
    }
  })();
};
</script>
</body>
</html>
